Global Environment (全局环境)

Declarative Environment Record (声明性环境记录)

Object Environment Record (对象环境记录)

Lexical Environment (词法环境)

Execution Context (执行上下文)

JavaScript 执行上下文与词法环境笔记（基于 ECMAScript 官方）
## 一、执行上下文（Execution Context）
1.1 定义

在 ECMAScript 规范中，每段可执行代码都关联一个执行上下文（EC）。它是 JavaScript 引擎用于管理代码执行状态的抽象结构。

执行上下文主要包含：

Lexical Environment（词法环境）

Variable Environment（变量环境）

This binding（this绑定）

1.2 类型

全局执行上下文（Global Execution Context）
执行全局代码时创建，生命周期与整个程序一致。

函数执行上下文（Function Execution Context）
每当函数被调用时创建，执行完毕后销毁。

Eval 执行上下文（Eval Execution Context）
当 eval() 执行代码时创建。

1.3 生命周期

Creation Phase（创建阶段）

创建 Lexical Environment 和 Variable Environment

确定 this 的值

函数声明提升（Hoisting）

变量声明初始化为 undefined

Execution Phase（执行阶段）

执行代码

对变量赋值

对函数调用进行解析

## 二、词法环境（Lexical Environment）
2.1 定义

词法环境是 ECMAScript 规范中用于管理标识符绑定（变量名与值映射）的抽象结构。

每个词法环境由两部分组成：

Environment Record（环境记录）

用于存储标识符和对应值

包括 Declarative Environment Record（函数作用域、块作用域）和 Object Environment Record（with 或全局对象绑定）

外部环境引用（outer）

指向父级词法环境，形成作用域链

2.2 全局环境

全局执行上下文的 Lexical Environment 被称为 Global Environment：

内部包含一个 Global Environment Record

持有全局变量和全局函数绑定

在浏览器中，对应 window 对象

2.3 函数环境

函数执行上下文会创建一个新的词法环境：

Declarative Environment Record 存储函数参数、局部变量、函数声明

outer 指向创建函数时的外部词法环境



```
var x = 1; // 全局环境

function outer(y) {
  var z = 3; // outer函数环境
  function inner() {
    console.log(x + y + z);
  }
  inner();
}

outer(2); // 输出 6

inner Lexical Environment -> outer Lexical Environment -> Global Lexical Environment


```
## 三、环境记录类型（Environment Record）
3.1 Declarative Environment Record

存储函数、块级作用域变量

典型场景：let, const, function 声明

3.2 Object Environment Record

将标识符绑定到对象属性

典型场景：

全局对象（如浏览器的 window）

with 语句块

## 四、变量解析过程

查找当前词法环境的 Environment Record

找不到则沿着 outer 链向上查找

最终到达 Global Environment
```
let a = 10;

function f() {
  let b = 20;
  function g() {
    let c = 30;
    console.log(a + b + c); // 60
  }
  g();
}
f();

```
## 五、ECMAScript 官方描述

Execution Context: 每段可执行代码创建一个 EC

Lexical Environment: 词法作用域和标识符绑定

Environment Record: 记录变量/函数绑定

Scope Chain: Lexical Environment 通过 outer 形成的链条
```mermaid
flowchart TD
    %% 全局环境
    GlobalEnv["Global Environment"]
    GA["a = 10"]
    GF["outer function"]

    %% outer 函数环境
    OuterEnv["outer() Lexical Environment"]
    OB["b = 5"]
    OC["c = 20"]
    OF["inner function"]

    %% inner 函数环境
    InnerEnv["inner() Lexical Environment"]
    ID["d = 30"]

    %% 嵌套关系
    GlobalEnv --> OuterEnv
    OuterEnv --> InnerEnv

    %% 作用域链
    InnerEnv --> OuterEnv --> GlobalEnv

    %% 内容
    GlobalEnv --> GA
    GlobalEnv --> GF

    OuterEnv --> OB
    OuterEnv --> OC
    OuterEnv --> OF

    InnerEnv --> ID

